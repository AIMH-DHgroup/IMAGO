# Annotation Django app

## Purpose

This directory contains the core Django application that implements the IMAGO annotation workflow. It defines the database schema, forms, views and management commands that allow scholars to describe relationships between authors, works and their physical manifestations (manuscripts and printed editions). The app stores records as JSON documents in JSONFields, providing flexibility for optional and nested fields.

## Directory overview
| Path                                      | Description                                                                                                                                                                                                                                                                                                                                                                           |
| ----------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `models.py`                               | Defines database models for lemmas, authors, works, places, libraries, genres and sources.  Each model stores its data inside a `JSONField`, so the schema can evolve without altering the database.                                                                                                                                                                                  |
| `forms.py`                                | Contains Django form classes for each entity: `LemmaForm`, `AuthorForm`, `WorkForm`, `ManuscriptForm` and `PrintEditionForm`.  These forms expose fields such as names, titles, dates, libraries, folios, incipits/excplicits and external IRIs.  Many fields use autocomplete widgets that query the controlled vocabularies to reduce typos and duplication.                        |
| `views.py`                                | Implements request handlers (function and class‑based views) that render templates, process form submissions and serve JSON responses for autocomplete.  Views also handle pagination and user permissions.                                                                                                                                                                           |
| `urls.py`                                 | Maps URL patterns to views and namespaces the annotation routes under the project’s root URL configuration.                                                                                                                                                                                                                                                                           |
| `admin.py`                                | Customises the Django admin interface for the JSON‑based models.                                                                                                                                                                                                                                                                                                                      |
| `management/commands/`                    | Contains command‑line tools: `import_iri` loads controlled vocabularies; `import_lemmas` imports existing lemmas; `update_lemmas` and `update_lemmas_libraries` update previously stored lemmas; `export_authors`, `export_libraries`, `export_places`, `export_notes` and other scripts output JSON datasets for reuse; `scrape_mirabile.py` demonstrates scraping external sources. |
| `csv/` and `json/`                        | Store curated datasets that feed the autocomplete widgets and initial imports.  See `annotation/json/README.md` for details.                                                                                                                                                                                                                                                          |
| `templates/annotation/`                   | HTML templates used by this app.  The templates leverage Bootstrap styles and jQuery UI autocomplete widgets to provide a clean, responsive interface.                                                                                                                                                                                                                                |
| `templatetags/`                           | Custom template tags used to format dates and other values.                                                                                                                                                                                                                                                                                                                           |
| `paginator.py`                            | Provides classes for paginating lists of lemmas or search results.                                                                                                                                                                                                                                                                                                                    |
| `middleware.py` / `SameSiteMiddleware.py` | Middleware to set cookie attributes and mitigate cross‑site request forgery.                                                                                                                                                                                                                                                                                                          |
## Workflow

1. Data import – Run `python manage.py import_iri` to load authors, works, libraries, places and genres from the JSON files in `annotation/json/`. These vocabularies power the autocomplete widgets. Then execute `python manage.py import_lemmas` to load existing lemma records (if any).

2. Create lemmas – Use the web interface to add a lemma. Fill out the author and work sections, then add one or more manuscript or print edition manifestations. Each manifestation allows you to record details such as library, shelfmark, date, incipit/excplicit, decoration and notes. Autocomplete fields connect to the imported vocabularies; if a term is missing, click the “add author” or “add work” link to open a mini‑form without leaving the page.

3. Save & review – Upon saving, the lemma’s data are stored in the `Lemma` model’s `data` JSON field along with references to linked models (author, work, place and library). Use the list view to browse or search lemmas and the detail view to edit them.

4. Export – When ready to publish, run the appropriate export commands (e.g., `python manage.py export_libraries`) to produce JSON files. These exports can be fed to the external imagoTriplifier to generate RDF/OWL.

## Customization

- Extending forms – To add new fields (e.g., to capture additional metadata), edit the appropriate form class in `forms.py` and update the corresponding template in `templates/annotation/`. Because each model stores data as JSON, you usually do not need to modify the database schema when adding optional fields.

- Adding datasets – New lookup lists can be introduced by adding JSON files to `annotation/json/` and updating `import_iri.py` to read them. After updating, run `python manage.py import_iri` again to load the new data.

- Management commands – If you need custom import/export logic, create a new Python module in `management/commands/` and subclass `BaseCommand`. Running `python manage.py your_command` will execute it.

## Data model notes

The models in this app use `JSONFields` to store structured data. For example, an author record contains a `name`, a list of `alias` values, an `irim` linking to external authority files, and a nested `datazione` dictionary capturing birth and death information (with flags for uncertainty, ante/post relationships and century abbreviations). A work record contains its `title`, the `author` name, an external IRI and optional aliases. Storing data as JSON simplifies imports from heterogeneous sources and supports incremental updates without altering the relational schema.